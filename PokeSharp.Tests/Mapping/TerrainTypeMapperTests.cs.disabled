using Arch.Core;
using NUnit.Framework;
using PokeSharp.Core.Components.Tiles;
using PokeSharp.Core.Mapping;

namespace PokeSharp.Tests.Mapping;

[TestFixture]
public class TerrainTypeMapperTests
{
    private TerrainTypeMapper _mapper = null!;
    private World _world = null!;

    [SetUp]
    public void Setup()
    {
        _mapper = new TerrainTypeMapper();
        _world = World.Create();
    }

    [TearDown]
    public void TearDown()
    {
        _world.Dispose();
    }

    [Test]
    public void CanMap_WithTerrainType_ReturnsTrue()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "terrain_type", "grass" }
        };

        // Act
        var canMap = _mapper.CanMap(props);

        // Assert
        Assert.That(canMap, Is.True);
    }

    [Test]
    public void CanMap_WithoutTerrainType_ReturnsFalse()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "solid", true }
        };

        // Act
        var canMap = _mapper.CanMap(props);

        // Assert
        Assert.That(canMap, Is.False);
    }

    [Test]
    public void Map_WithTypeAndSound_CreatesTerrainType()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "terrain_type", "grass" },
            { "footstep_sound", "footstep_grass" }
        };

        // Act
        var terrain = _mapper.Map(props);

        // Assert
        Assert.That(terrain.TypeId, Is.EqualTo("grass"));
        Assert.That(terrain.FootstepSound, Is.EqualTo("footstep_grass"));
    }

    [Test]
    public void Map_WithoutFootstepSound_UsesEmptyString()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "terrain_type", "water" }
        };

        // Act
        var terrain = _mapper.Map(props);

        // Assert
        Assert.That(terrain.TypeId, Is.EqualTo("water"));
        Assert.That(terrain.FootstepSound, Is.EqualTo(string.Empty));
    }

    [Test]
    [TestCase("grass")]
    [TestCase("water")]
    [TestCase("sand")]
    [TestCase("cave")]
    [TestCase("snow")]
    [TestCase("ice")]
    public void Map_CommonTerrainTypes_CreatesCorrectComponent(string terrainType)
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "terrain_type", terrainType }
        };

        // Act
        var terrain = _mapper.Map(props);

        // Assert
        Assert.That(terrain.TypeId, Is.EqualTo(terrainType));
    }

    [Test]
    public void Map_EmptyTerrainType_ThrowsException()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "terrain_type", "" }
        };

        // Act & Assert
        var ex = Assert.Throws<InvalidOperationException>(() => _mapper.Map(props));
        Assert.That(ex!.Message, Does.Contain("empty or whitespace"));
    }

    [Test]
    public void Map_WhitespaceTerrainType_ThrowsException()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "terrain_type", "   " }
        };

        // Act & Assert
        var ex = Assert.Throws<InvalidOperationException>(() => _mapper.Map(props));
        Assert.That(ex!.Message, Does.Contain("empty or whitespace"));
    }

    [Test]
    public void Map_MissingTerrainType_ThrowsException()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "footstep_sound", "footstep_grass" }
        };

        // Act & Assert
        Assert.Throws<InvalidOperationException>(() => _mapper.Map(props));
    }

    [Test]
    public void MapAndAdd_ValidProperties_AddsComponentToEntity()
    {
        // Arrange
        var entity = _world.Create();
        var props = new Dictionary<string, object>
        {
            { "terrain_type", "sand" },
            { "footstep_sound", "footstep_sand" }
        };

        // Act
        _mapper.MapAndAdd(_world, entity, props);

        // Assert
        Assert.That(_world.Has<TerrainType>(entity), Is.True);
        var terrain = _world.Get<TerrainType>(entity);
        Assert.That(terrain.TypeId, Is.EqualTo("sand"));
        Assert.That(terrain.FootstepSound, Is.EqualTo("footstep_sand"));
    }

    [Test]
    public void MapAndAdd_InvalidProperties_DoesNotAddComponent()
    {
        // Arrange
        var entity = _world.Create();
        var props = new Dictionary<string, object>
        {
            { "solid", true }
        };

        // Act
        _mapper.MapAndAdd(_world, entity, props);

        // Assert
        Assert.That(_world.Has<TerrainType>(entity), Is.False);
    }

    [Test]
    public void Map_NullFootstepSound_UsesEmptyString()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "terrain_type", "grass" },
            { "footstep_sound", null! }
        };

        // Act
        var terrain = _mapper.Map(props);

        // Assert
        Assert.That(terrain.FootstepSound, Is.EqualTo(string.Empty));
    }

    [Test]
    public void Map_PokemonStandardTerrains_CreatesValidComponents()
    {
        // Test typical Pokemon terrain types
        var testCases = new[]
        {
            ("grass", "footstep_grass"),
            ("sand", "footstep_sand"),
            ("cave", "footstep_cave"),
            ("water", "footstep_water"),
            ("snow", "footstep_snow"),
            ("ice", "footstep_ice")
        };

        foreach (var (terrainType, footstepSound) in testCases)
        {
            // Arrange
            var props = new Dictionary<string, object>
            {
                { "terrain_type", terrainType },
                { "footstep_sound", footstepSound }
            };

            // Act
            var terrain = _mapper.Map(props);

            // Assert
            Assert.That(terrain.TypeId, Is.EqualTo(terrainType), $"Type mismatch for {terrainType}");
            Assert.That(terrain.FootstepSound, Is.EqualTo(footstepSound), $"Sound mismatch for {terrainType}");
        }
    }
}
