using Arch.Core;
using NUnit.Framework;
using PokeSharp.Core.Components.Maps;
using PokeSharp.Core.Mapping;

namespace PokeSharp.Tests.Mapping;

[TestFixture]
public class EncounterZoneMapperTests
{
    private EncounterZoneMapper _mapper = null!;
    private World _world = null!;

    [SetUp]
    public void Setup()
    {
        _mapper = new EncounterZoneMapper();
        _world = World.Create();
    }

    [TearDown]
    public void TearDown()
    {
        _world.Dispose();
    }

    [Test]
    public void CanMap_WithEncounterRate_ReturnsTrue()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", 25 }
        };

        // Act
        var canMap = _mapper.CanMap(props);

        // Assert
        Assert.That(canMap, Is.True);
    }

    [Test]
    public void CanMap_WithoutEncounterRate_ReturnsFalse()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "solid", true }
        };

        // Act
        var canMap = _mapper.CanMap(props);

        // Assert
        Assert.That(canMap, Is.False);
    }

    [Test]
    public void Map_WithIntegerRate_CreatesEncounterZone()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", 25 },
            { "encounter_table", "tall_grass" }
        };

        // Act
        var zone = _mapper.Map(props);

        // Assert
        Assert.That(zone.EncounterRate, Is.EqualTo(25));
        Assert.That(zone.EncounterTableId, Is.EqualTo("tall_grass"));
    }

    [Test]
    public void Map_WithStringRate_ParsesCorrectly()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", "30" }
        };

        // Act
        var zone = _mapper.Map(props);

        // Assert
        Assert.That(zone.EncounterRate, Is.EqualTo(30));
    }

    [Test]
    public void Map_WithoutEncounterTable_UsesEmptyString()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", 20 }
        };

        // Act
        var zone = _mapper.Map(props);

        // Assert
        Assert.That(zone.EncounterRate, Is.EqualTo(20));
        Assert.That(zone.EncounterTableId, Is.EqualTo(string.Empty));
    }

    [Test]
    [TestCase(0)]
    [TestCase(1)]
    [TestCase(128)]
    [TestCase(255)]
    public void Map_ValidRateRange_CreatesEncounterZone(int rate)
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", rate }
        };

        // Act
        var zone = _mapper.Map(props);

        // Assert
        Assert.That(zone.EncounterRate, Is.EqualTo(rate));
    }

    [Test]
    [TestCase(-1)]
    [TestCase(256)]
    [TestCase(1000)]
    public void Map_OutOfRangeRate_ThrowsException(int rate)
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", rate }
        };

        // Act & Assert
        var ex = Assert.Throws<InvalidOperationException>(() => _mapper.Map(props));
        Assert.That(ex!.Message, Does.Contain("must be between 0 and 255"));
    }

    [Test]
    public void Map_InvalidRateString_ThrowsException()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", "not_a_number" }
        };

        // Act & Assert
        var ex = Assert.Throws<InvalidOperationException>(() => _mapper.Map(props));
        Assert.That(ex!.Message, Does.Contain("Invalid encounter_rate value"));
    }

    [Test]
    public void Map_MissingEncounterRate_ThrowsException()
    {
        // Arrange
        var props = new Dictionary<string, object>
        {
            { "encounter_table", "water" }
        };

        // Act & Assert
        Assert.Throws<InvalidOperationException>(() => _mapper.Map(props));
    }

    [Test]
    public void MapAndAdd_WithPositiveRate_AddsComponent()
    {
        // Arrange
        var entity = _world.Create();
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", 25 },
            { "encounter_table", "grass" }
        };

        // Act
        _mapper.MapAndAdd(_world, entity, props);

        // Assert
        Assert.That(_world.Has<EncounterZone>(entity), Is.True);
        var zone = _world.Get<EncounterZone>(entity);
        Assert.That(zone.EncounterRate, Is.EqualTo(25));
        Assert.That(zone.EncounterTableId, Is.EqualTo("grass"));
    }

    [Test]
    public void MapAndAdd_WithZeroRate_DoesNotAddComponent()
    {
        // Arrange
        var entity = _world.Create();
        var props = new Dictionary<string, object>
        {
            { "encounter_rate", 0 }
        };

        // Act
        _mapper.MapAndAdd(_world, entity, props);

        // Assert
        Assert.That(_world.Has<EncounterZone>(entity), Is.False);
    }

    [Test]
    public void MapAndAdd_InvalidProperties_DoesNotAddComponent()
    {
        // Arrange
        var entity = _world.Create();
        var props = new Dictionary<string, object>
        {
            { "solid", true }
        };

        // Act
        _mapper.MapAndAdd(_world, entity, props);

        // Assert
        Assert.That(_world.Has<EncounterZone>(entity), Is.False);
    }

    [Test]
    public void Map_PokemonStandardRates_CreatesValidZones()
    {
        // Test typical Pokemon encounter rates
        var testCases = new[]
        {
            ("tall_grass", 25),
            ("water", 10),
            ("cave", 15),
            ("special", 5)
        };

        foreach (var (table, rate) in testCases)
        {
            // Arrange
            var props = new Dictionary<string, object>
            {
                { "encounter_rate", rate },
                { "encounter_table", table }
            };

            // Act
            var zone = _mapper.Map(props);

            // Assert
            Assert.That(zone.EncounterRate, Is.EqualTo(rate), $"Rate mismatch for {table}");
            Assert.That(zone.EncounterTableId, Is.EqualTo(table), $"Table mismatch for {table}");
        }
    }
}
